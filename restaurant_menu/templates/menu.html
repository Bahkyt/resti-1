<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Меню — Мансарда</title>
  <style>
    :root{
      --bg: {{ theme.bg or '#020617' }};
      --card: {{ theme.card or '#181820' }};
      --muted: {{ theme.muted or '#9aa3b2' }};
      --text: {{ theme.text or '#f5f7fb' }};
      --brand: {{ theme.brand or '#ffbd2f' }};
      --accent: {{ theme.accent or '#4fd1c5' }};
      --border: {{ theme.border or 'rgba(255,255,255,.12)' }};
      --radius: 18px;
      --header-h: 64px;
      --catbar-h: 54px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }

    html,body{
      height:100%;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      padding-top: calc(var(--header-h) + 8px);
    }

    body.no-scroll{
      overflow:hidden;
      touch-action:none;
    }

    img{
      max-width:100%;
      display:block;
    }

    a{
      color:inherit;
      text-decoration:none;
    }

    .shell{
      max-width:1200px;
      margin:0 auto;
      padding:0 16px;
    }


    header{
      position:fixed;
      top:0;
      left:0;
      right:0;
      height:var(--header-h);
      z-index:100;
      backdrop-filter:saturate(180%) blur(16px);
      background:linear-gradient(180deg,rgba(0,0,0,.96),rgba(0,0,0,.9));
      border-bottom:1px solid var(--border);
    }

    .header-inner{
      height:100%;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .logo-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .brand{
      font-weight:800;
      letter-spacing:.5px;
      white-space:nowrap;
    }

    .lang-switch{
      margin-left:auto;
      display:inline-flex;
      gap:6px;
      align-items:center;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--muted);
      padding:4px 10px;
      cursor:pointer;
      font-size:12px;
    }
    .lang-switch span{opacity:.6}
    .lang-switch .active{opacity:1; font-weight:700}


    .page{
      max-width:1200px;
      margin:0 auto;
      padding:12px 16px 72px;
    }

    .menu-strip{
      display:flex;
      gap:12px;
      overflow-x:auto;
      overscroll-behavior-inline:contain;
      -webkit-overflow-scrolling:touch;
      touch-action:pan-x;
      padding:4px 2px 10px;
      margin-bottom:4px;
      scrollbar-width:thin;
    }
    .menu-strip::-webkit-scrollbar{height:6px}
    .menu-strip::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.15);
      border-radius:999px;
    }

    .menu-card{
      flex:0 0 145px;
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      overflow:hidden;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
      transform-origin:center;
      transition:transform .16s ease-out, box-shadow .16s ease-out, border-color .16s ease-out, background .16s ease-out;
      display:flex;
      flex-direction:column;
      color:var(--text);
    }
    .menu-card:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 36px rgba(0,0,0,.55);
      border-color:rgba(255,255,255,.16);
    }
    .menu-card.active{
      border-color:var(--brand);
      box-shadow:0 16px 40px rgba(0,0,0,.7);
      background:linear-gradient(145deg,var(--card),rgba(0,0,0,.9));
    }
    .menu-card-img{
      width:100%;
      height:90px;
      overflow:hidden;
      background:var(--bg);
    }
    .menu-card-img img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
    }
    .menu-card-body{
      padding:8px 10px 10px;
      font-size:14px;
      font-weight:600;
    }

    .search-wrap{
      margin:4px 0 6px;
    }

    .search-input{
      width:100%;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      padding:9px 14px;
      font-size:14px;
      outline:none;
    }

    .info-strip{
      margin-top:4px;
      margin-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      font-size:12px;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .info-strip-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .info-service-label{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:700;
      font-size:11px;
    }
    .info-strip-line{
      width:42px;
      height:2px;
      background:var(--brand);
      border-radius:999px;
    }
    .info-strip-right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .info-strip-caption{
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:10px;
      opacity:.7;
    }
    .info-strip-hours{
      font-weight:600;
      color:var(--text);
    }


    .catbar-sticky{
      position:sticky;
      top:var(--header-h);
      z-index:80;
      padding:4px 0 2px;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      margin-bottom:6px;
    }

    .catbar{
      display:flex;
      gap:10px;
      overflow-x:auto;
      overscroll-behavior-inline:contain;
      -webkit-overflow-scrolling:touch;
      touch-action:pan-x;
      padding:6px 0 8px;
      scrollbar-width:thin;
    }
    .catbar::-webkit-scrollbar{height:6px}
    .catbar::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.15);
      border-radius:999px;
    }

    .cat{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--muted);
      white-space:nowrap;
      font-size:14px;
      cursor:pointer;
      transition:background .15s ease-out,color .15s ease-out,border-color .15s ease-out,transform .12s ease-out;
    }
    .cat:hover{
      color:var(--text);
      transform:translateY(-1px);
    }
    .cat.active{
      background:rgba(255,255,255,.08);
      color:var(--brand);
      border-color:var(--brand);
      font-weight:700;
    }

    .category{
      scroll-margin-top:calc(var(--header-h) + var(--catbar-h) + 12px);
    }

    h2{
      font-size:20px;
      margin:14px 0 10px;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
      gap:12px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow:0 14px 32px rgba(0,0,0,.65);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      min-height:210px;
      transition:transform .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out, background .15s ease-out;
      color:var(--text);
    }
    .card:hover{
      transform:translateY(-3px);
      box-shadow:0 18px 40px rgba(0,0,0,.85);
      border-color:rgba(255,255,255,.14);
    }

    .thumb{
      height:145px;
      overflow:hidden;
      background:var(--bg);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      transition:transform .3s ease-out;
    }
    .card:hover .thumb img{
      transform:scale(1.03);
    }

    .card-body{
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1;
    }

    .title{
      font-weight:600;
      font-size:15px;
      letter-spacing:.01em;
    }

    .meta{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:8px;
      margin-top:auto;
    }

    .ing{
      font-size:12px;
      color:var(--muted);
      max-height:3.1em;
      overflow:hidden;
    }

    .price{
      font-weight:700;
      font-size:15px;
      white-space:nowrap;
      color:var(--brand);
    }


    .sheet{
      position:fixed;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index:120;
      pointer-events:none;
      opacity:0;
      transition:opacity .18s ease-out;
      background:rgba(0,0,0,.4);
    }
    .sheet.open{
      pointer-events:auto;
      opacity:1;
    }

    .sheet-inner{
      width:100%;
      max-width:480px;
      background:var(--bg);
      border-radius:18px 18px 0 0;
      box-shadow:0 -20px 50px rgba(0,0,0,.85);
      transform:translateY(100%);
      transition:transform .22s ease-out;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      color:var(--text);
    }

    .sheet-handle{
      padding:8px 0 4px;
      display:flex;
      justify-content:center;
    }

    .handle{
      width:40px;
      height:4px;
      border-radius:999px;
      background:rgba(148,163,184,.55);
    }

    .sheet-content{
      padding:12px 16px 10px;
      overflow:auto;
      flex:1;
    }

    .sheet-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:4px;
    }

    .sheet-price{
      font-size:16px;
      font-weight:600;
      margin-bottom:6px;
      color:var(--brand);
    }

    .sheet-ing-label{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.16em;
      margin-bottom:2px;
    }

    .sheet-ing{
      font-size:13px;
      color:var(--text);
      line-height:1.4;
    }

    .sheet-img{
      margin-bottom:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      background:var(--bg);
    }

    .sheet-img img{
      width:100%;
      height:220px;
      object-fit:cover;
      object-position:center;
    }

    .sheet-close{
      padding:10px 16px 14px;
      border-top:1px solid var(--border);
    }

    .btn{
      width:100%;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      cursor:pointer;
      font-size:14px;
      padding:9px 0;
    }


    .footer{
      border-top:1px solid var(--border);
      padding:14px 16px 24px;
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      background:var(--bg);
    }
    .footer-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:10px 24px;
      justify-content:space-between;
    }
    .footer-block{
      min-width:140px;
    }
    .footer-label{
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:10px;
      opacity:.7;
      margin-bottom:2px;
    }
    .footer-value{
      font-size:12px;
    }
    .footer-link{
      text-decoration:none;
      color:var(--text);
    }
    .footer-link:hover{
      color:var(--accent);
    }


    @media (max-width:768px){
      :root{
        --header-h:60px;
        --catbar-h:52px;
      }
      h2{font-size:18px;}
      .grid{
        grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
      }
    }

    @media (max-width:480px){
      .grid{
        grid-template-columns:1fr;
      }
      body{
        padding-top:calc(var(--header-h) + 6px);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="shell header-inner">
      <div class="logo-wrap">
        <img src="{{ url_for('static', filename='img/emblem.png') }}" alt="" width="40">
        <div
          class="brand"
          id="brandTitle"
          style="font-family: {{ theme.brand_font or 'system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell' }};"
        >
          Mansarda
        </div>
      </div>
      <button class="lang-switch" id="langBtn" type="button" aria-label="Switch language">
        <span id="langRU" class="active">RU</span> |
        <span id="langKK">KK</span> |
        <span id="langEN">EN</span>
      </button>
    </div>
  </header>

  <main class="page">
    <div class="menu-strip" id="menuStrip"></div>

    <div class="search-wrap">
      <input id="searchInput" class="search-input" placeholder="Поиск по блюдам...">
      <div class="info-strip">
        <div class="info-strip-left">
          <div class="info-service-label">Обслуживание 10%</div>
          <div class="info-strip-line"></div>
        </div>
        <div class="info-strip-right">
          <div class="info-strip-caption">Режим работы</div>
          <div class="info-strip-hours">11:00 – 23:00</div>
        </div>
      </div>
    </div>

    <div class="catbar-sticky">
      <nav class="catbar" id="catbar"></nav>
    </div>

    <div id="content"></div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-block">
        <div class="footer-label">Адрес</div>
        <div class="footer-value">ул. Жукова, 145</div>
      </div>
      <div class="footer-block">
        <div class="footer-label">Телефон</div>
        <div class="footer-value" id="footerPhone"></div>
      </div>
      <div class="footer-block">
        <div class="footer-label">Instagram</div>
        <a href="https://instagram.com/Mansarda_zhukova" target="_blank" class="footer-value footer-link">@Mansarda_zhukova</a>
      </div>
    </div>
  </footer>

  <div class="sheet" id="sheet" aria-hidden="true">
    <div class="sheet-inner" id="sheetInner">
      <div class="sheet-handle"><div class="handle"></div></div>
      <div class="sheet-content" id="sheetContent"></div>
      <div class="sheet-close">
        <button class="btn" id="closeBtn">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    const PHONE = {{ (phone or "")|tojson }};
    const MANSARDA_NAME = "Mansarda";

    const STR = {
      ru: {
        ingredients: "Ингредиенты:",
        close: "Закрыть",
        searchPlaceholder: "Поиск по блюдам..."
      },
      kk: {
        ingredients: "Құрамы:",
        close: "Жабу",
        searchPlaceholder: "Тағамдар бойынша іздеу..."
      },
      en: {
        ingredients: "Ingredients:",
        close: "Close",
        searchPlaceholder: "Search dishes..."
      }
    };

    const LANG_KEY = { ru: "ru", kk: "kz", en: "en" };

    const DATA = {
      menus: {{ menus|tojson }},
      categories: {{ categories|tojson }},
      items: {{ items|tojson }}
    };

    const menuStrip = document.getElementById("menuStrip");
    const catbar = document.getElementById("catbar");
    const content = document.getElementById("content");
    const brandTitle = document.getElementById("brandTitle");
    const searchInput = document.getElementById("searchInput");
    const footerPhone = document.getElementById("footerPhone");
    const sheet = document.getElementById("sheet");
    const sheetInner = document.getElementById("sheetInner");
    const sheetContent = document.getElementById("sheetContent");
    const closeBtn = document.getElementById("closeBtn");
    const langBtn = document.getElementById("langBtn");
    const langRU = document.getElementById("langRU");
    const langKK = document.getElementById("langKK");
    const langEN = document.getElementById("langEN");

    if (footerPhone && PHONE) {
      footerPhone.textContent = PHONE;
    }

    const rub = (n) => new Intl.NumberFormat("ru-RU").format(n) + " ₸";

    const getLang = () => localStorage.getItem("lang") || "ru";
    const setLang = (l) => localStorage.setItem("lang", l);

    function pick(obj, base, lang) {
      const key = base + "_" + (LANG_KEY[lang] || "ru");
      return (obj && obj[key]) || (obj && obj[base + "_ru"]) || "";
    }

    function updateLangStatic(lang) {
      searchInput.placeholder = STR[lang].searchPlaceholder;
      closeBtn.textContent = STR[lang].close;
      langRU.classList.toggle("active", lang === "ru");
      langKK.classList.toggle("active", lang === "kk");
      langEN.classList.toggle("active", lang === "en");
      document.documentElement.lang = lang;
    }

    let currentMenuId = DATA.menus.length ? DATA.menus[0].id : null;
    let searchTerm = "";

    function renderMenuStrip(lang) {
      menuStrip.innerHTML = DATA.menus.map(m => {
        const title = pick(m, "title", lang);
        const img = m.image ? `<img src="${m.image}" alt="${title}">` : "";
        return `
          <button class="menu-card ${m.id === currentMenuId ? "active" : ""}" data-menu-id="${m.id}">
            <div class="menu-card-img">${img}</div>
            <div class="menu-card-body">${title}</div>
          </button>
        `;
      }).join("");
    }

    function renderCatbar(lang) {
      const cats = DATA.categories.filter(c => c.menu_id === currentMenuId);
      catbar.innerHTML = cats.map((c, idx) => `
        <button class="cat ${idx === 0 ? "active" : ""}" data-cat-id="${c.id}">
          ${pick(c, "name", lang)}
        </button>
      `).join("");
    }

    function renderContent(lang) {
      const cats = DATA.categories.filter(c => c.menu_id === currentMenuId);
      const term = searchTerm.trim().toLowerCase();

      content.innerHTML = cats.map(c => {
        const items = DATA.items.filter(i => i.category_id === c.id).filter(i => {
          if (!term) return true;
          const title = pick(i, "title", lang).toLowerCase();
          const ing = pick(i, "ing", lang).toLowerCase();
          return title.includes(term) || ing.includes(term);
        });

        if (!items.length) return "";

        return `
          <section class="category" id="cat-${c.id}">
            <h2>${pick(c, "name", lang)}</h2>
            <div class="grid">
              ${items.map(item => `
                <article class="card" data-item-id="${item.id}">
                  <div class="thumb">
                    ${item.image ? `<img src="${item.image}" alt="${pick(item,"title",lang)}">` : ""}
                  </div>
                  <div class="card-body">
                    <div class="title">${pick(item, "title", lang)}</div>
                    <div class="meta">
                      <div class="ing">${pick(item, "ing", lang)}</div>
                      <div class="price">${rub(item.price)}</div>
                    </div>
                  </div>
                </article>
              `).join("")}
            </div>
          </section>
        `;
      }).join("");
    }

    function rerenderAll() {
      const lang = getLang();
      updateLangStatic(lang);
      renderMenuStrip(lang);
      renderCatbar(lang);
      renderContent(lang);
    }


    menuStrip.addEventListener("click", (e) => {
      const card = e.target.closest(".menu-card");
      if (!card) return;
      const id = Number(card.dataset.menuId);
      if (id === currentMenuId) return;
      currentMenuId = id;
      rerenderAll();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });


    catbar.addEventListener("click", (e) => {
      const btn = e.target.closest(".cat");
      if (!btn) return;
      const catId = Number(btn.dataset.catId);
      const all = catbar.querySelectorAll(".cat");
      all.forEach(el => el.classList.remove("active"));
      btn.classList.add("active");

      const target = document.getElementById(`cat-${catId}`);
      if (!target) return;

      const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--header-h")) || 64;
      const catbarH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--catbar-h")) || 54;
      const gap = 12;

      const rect = target.getBoundingClientRect();
      const offsetTop = rect.top + window.scrollY - headerH - catbarH - gap;

      window.scrollTo({ top: offsetTop, behavior: "smooth" });
    });


    searchInput.addEventListener("input", () => {
      searchTerm = searchInput.value;
      renderContent(getLang());
    });


    content.addEventListener("click", (e) => {
      const card = e.target.closest(".card");
      if (!card) return;
      const id = Number(card.dataset.itemId);
      const item = DATA.items.find(x => x.id === id);
      if (!item) return;
      openSheet(item, getLang());
    });

    function openSheet(item, lang) {
      const title = pick(item, "title", lang);
      const price = rub(item.price);
      const ingText = pick(item, "ing", lang);

      sheetContent.innerHTML = `
        <div class="sheet-img">
          ${item.image ? `<img src="${item.image}" alt="${title}">` : ""}
        </div>
        <div class="sheet-title">${title}</div>
        <div class="sheet-price">${price}</div>
        ${ingText ? `
          <div class="sheet-ing-label">${STR[lang].ingredients}</div>
          <div class="sheet-ing">${ingText}</div>
        ` : ""}
      `;

      sheet.classList.add("open");
      sheet.setAttribute("aria-hidden", "false");
      sheetInner.style.transform = "translateY(0)";
      document.body.classList.add("no-scroll");
    }

    function closeSheet() {
      sheetInner.style.transform = "translateY(100%)";
      setTimeout(() => {
        sheet.classList.remove("open");
        sheet.setAttribute("aria-hidden", "true");
      }, 200);
      document.body.classList.remove("no-scroll");
      dragging = false;
      currentY = 0;
    }

    closeBtn.addEventListener("click", closeSheet);

    sheet.addEventListener("click", (e) => {
      if (e.target === sheet) {
        closeSheet();
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && sheet.classList.contains("open")) {
        closeSheet();
      }
    });


    let startY = 0;
    let currentY = 0;
    let dragging = false;
    const threshold = 90;

    function onStart(y){
      if (!sheet.classList.contains("open")) return;
      dragging = true;
      startY = y;
      currentY = 0;
      sheetInner.style.transition = "none";
    }
    function onMove(y){
      if(!dragging) return;
      currentY = Math.max(0, y - startY);
      sheetInner.style.transform = `translateY(${currentY}px)`;
    }
    function onEnd(){
      if(!dragging) return;
      sheetInner.style.transition = "transform .22s ease-out";
      if(currentY > threshold){
        closeSheet();
      }else{
        sheetInner.style.transform = "translateY(0)";
      }
      dragging = false;
    }

    sheetInner.addEventListener("touchstart", e=>onStart(e.touches[0].clientY), {passive:true});
    sheetInner.addEventListener("touchmove",  e=>{
      if (!sheet.classList.contains("open")) return;
      if (dragging){
        e.preventDefault();
        onMove(e.touches[0].clientY);
      }
    }, {passive:false});
    sheetInner.addEventListener("touchend",   onEnd);

    sheetInner.addEventListener("mousedown", e=>onStart(e.clientY));
    window.addEventListener("mousemove", e=>{
      if (!dragging) return;
      onMove(e.clientY);
    });
    window.addEventListener("mouseup", onEnd);


    langBtn.addEventListener("click", () => {
      const cur = getLang();
      const next = cur === "ru" ? "kk" : (cur === "kk" ? "en" : "ru");
      setLang(next);
      rerenderAll();
    });

    if (!localStorage.getItem("lang")) setLang("ru");

    rerenderAll();


    function updateBrandOnScroll(){
      const y = window.scrollY || document.documentElement.scrollTop;
      if (y > 80 && PHONE) brandTitle.textContent = PHONE;
      else brandTitle.textContent = MANSARDA_NAME;
    }
    window.addEventListener("scroll", updateBrandOnScroll);
    updateBrandOnScroll();
  </script>
</body>
</html>
